# Ray Tracing in One Week Notes
ç”¨Rustå®ç°ï¼Œè®°å½•å¯¹the bookçš„å­¦ä¹ ç†è§£è¿›ç¨‹ï¼Œä¸å¯¹Rustç‰¹æ€§çš„å­¦ä¹ æ¢ç´¢æœ‰æ„Ÿ

## References
[ç”¨CUDAè¿›è¡ŒGPUåŠ é€Ÿè®¡ç®—](https://zhuanlan.zhihu.com/p/481545755)

[ç”¨CUDAè¿›è¡ŒGPUåŠ é€Ÿè®¡ç®— è‹±æ–‡åŸæ–‡](https://developer.nvidia.com/blog/accelerated-ray-tracing-cuda/)

[å…‰è¿½èµ„æ–™æ”¶é›†](https://www.bilibili.com/read/cv2317592/)

[è®¡ç®—æœºå›¾å½¢å­¦å…¥é—¨èµ„æ–™åˆé›†](https://blog.csdn.net/weixin_31226805/article/details/111969351?ops_request_misc=&request_id=&biz_id=102&utm_term=Ray%20Tracing%20in%20one%20weekend%20CUD&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-5-111969351.142^v70^wechat_v2,201^v4^add_ask)

[ä»å…‰çº¿è¿½è¸ªåˆ°è·¯å¾„è¿½è¸ª](https://zhuanlan.zhihu.com/p/138317358)

[æ€»ç»“ã€ŠRay Tracing from the Ground Upã€‹](https://blog.csdn.net/libing_zeng/article/details/72625390)

[å…‰æ …æ¸²æŸ“å™¨å­¦ä¹ æ€»ç»“åšå®¢](https://zhuanlan.zhihu.com/p/141210744)

## Output an Image
äº†è§£PPMæ ¼å¼
```text
P3 # fixed
256 256 # weigh height
256 # colors
r g b
r g b
# left to right, and then up to down
......
```
![](./imgs/2023-01-04-22-34-13.png)

## The vec3 Class
è¢«Rustè¿ç®—ç¬¦é‡è½½æŠ˜ç£¨äº†ä¸€ä¸‹ï¼Œç›¸æ¯”C++åªéœ€é‡è½½ä¸€ä¸ªå‡½æ•°ï¼ŒRustéœ€è¦å®ç°ä¸€ä¸ªTraitï¼Œå¤šåŒ…äº†ä¸€å±‚æœ‰äº¿ç‚¹å†—é•¿ã€‚ç„¶åå·¦å³ä¸åŒç±»å‹ä¹Ÿæ˜¯è¦å®ç°ä¸¤æ¬¡ï¼Œ`XXAssign`ä¹Ÿè¦é‡æ–°å®ç°ï¼Œå¾ˆéº»çƒ¦ä½†è²Œä¼¼ç¡®å®æ²¡å•¥å¤ªå¥½çš„åŠæ³•ã€‚(å½“æ—¶åˆšå­¦C++è¿ç®—ç¬¦é‡è½½æ—¶ä¹Ÿæ˜¯ä¸€è„¸æ‡µé€¼)

![](./imgs/2023-01-05-08-54-46.png "è¦æ˜¯èƒ½åƒè¿™æ ·æ‰“åŒ…ä¸€ä¸‹ï¼Œä¸ç”¨å†™é‚£ä¹ˆå¤štraitä¹Ÿå¥½å“‡")

ç›¸æ¯”åŸæ–‡çš„`using point3=vec3;using color=vec3;`ï¼ŒRusté€‚åˆä½¿ç”¨**new type**æ¨¡å¼ï¼Œç”¨`tuple struct`è€Œé`type`ï¼Œå®ç°å¼ºç±»å‹çº¦æŸï¼Œä¸ä¼šçŠ¯æŠŠä¸€ä¸ªé¢œè‰²åŠ åˆ°ä¸€ä¸ªåæ ‡ä¸Šçš„é”™è¯¯
* ç»è¿‡å®è·µï¼Œå‘ç°è¿™æ ·çš„ç±»å‹çº¦æŸä¹Ÿæœ‰é‚£ä¹ˆç‚¹é¸¡è‚‹çš„æ„Ÿè§‰ï¼Œè¦æ˜¯æˆ‘ä¹ æƒ¯åŠ .0äº†é‚£ä¸å°±å®Œå…¨ä¸èµ·ä½œç”¨äº†å—ğŸ¤£ã€‚

## Ray, a Simple Camera, and Background
### Ray Class
èµ·ç‚¹å’Œæ–¹å‘ç»„æˆä¸€æŸå…‰çº¿(tä¸ºæ­£æ•°æ—¶ä¸ºå°„çº¿)

### åœ¨åœºæ™¯ä¸­å‘å°„å…‰çº¿
å…‰çº¿è¿½è¸ªå™¨å‘é€å…‰ï¼Œå¹¶è®¡ç®—è¿™äº›å…‰è·¯æ–¹å‘ä¸Šçš„é¢œè‰²ã€‚éœ€è¦ä»¥ä¸‹å‡ æ­¥ï¼š
1. è®¡ç®—ä»çœ¼ç›åˆ°åƒç´ çš„å…‰çº¿(å…‰è·¯å¯é€†)ï¼Œå°†å°„çº¿ä»è§†ç‚¹å‘å°„åˆ°åƒç´ åæ ‡
2. åˆ¤æ–­å“ªä¸ªç‰©ä½“ä¸å…‰çº¿ç›¸äº¤ï¼Œç›¸äº¤ä½ç½®
3. è®¡ç®—å‡ºç›¸äº¤ç‚¹ä¸Šçš„é¢œè‰²

å‘å°„æ—¶å°„çº¿å‘é‡å¹¶ä¸éœ€è¦æ˜¯å•ä½å‘é‡

é™¤äº†è®¾ç½®æ¸²æŸ“å›¾åƒçš„åƒç´ å°ºå¯¸å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è®¾ç½®ä¸€ä¸ª**è™šæ‹Ÿè§†å£**æ¥**ä¼ é€’æˆ‘ä»¬çš„åœºæ™¯å…‰çº¿**ã€‚å¯¹äºæ ‡å‡†çš„æ­£æ–¹å½¢åƒç´ é—´è·ï¼Œè§†å£çš„çºµæ¨ªæ¯”åº”è¯¥ä¸æˆ‘ä»¬æ¸²æŸ“çš„å›¾åƒç›¸åŒã€‚æˆ‘ä»¬åªé€‰æ‹©ä¸€ä¸ªé«˜åº¦ä¸ºä¸¤ä¸ªå•ä½(-1~+1)çš„è§†å£ã€‚æˆ‘ä»¬è¿˜**å°†æŠ•å½±å¹³é¢å’ŒæŠ•å½±ç‚¹ä¹‹é—´çš„è·ç¦»è®¾ç½®ä¸ºä¸€ä¸ªå•ä½**ã€‚è¿™è¢«ç§°ä¸ºâ€œç„¦é•¿åº¦â€(`focal_length`)ï¼Œä¸æ˜¯ç„¦è·ï¼

![](./imgs/2023-01-05-10-18-27.png)

å·¦æ‰‹ç³»,ç›¸æœºåœ¨(0,0,0),xæ­£æ–¹å‘ä¸ºå³ï¼Œyæ­£æ–¹å‘ä¸ºä¸Šï¼Œåœºæ™¯çš„zä¸ºè´Ÿæ•°

äº†è§£äº†ä¸€ä¸‹C++çš„`constexpr`å‡½æ•°ä¸Rustçš„`const fn`ã€‚å®ƒä»¬å¯ä»¥ç”¨æ¥åˆå§‹åŒ–å¸¸é‡ï¼›æ¡ä»¶æ˜¯ä¿è¯åªè¦æ‰€æœ‰å‚æ•°éƒ½æ˜¯å¸¸é‡è¡¨è¾¾å¼ï¼Œè¿”å›å€¼å°±ä¸€å®šæ˜¯(ç¼–è¯‘æœŸèƒ½è®¡ç®—å‡ºæ¥çš„)å¸¸é‡è¡¨è¾¾å¼ã€‚
* Rustçš„`Trait Implement`ä¸­æ— æ³•ä½¿ç”¨`const fn`ï¼Œä½†æœ‰å®éªŒæ€§çš„`impl const XXTrait for XXStruct{}`è¯­æ³•ã€‚
* Rustçš„`const fn`ä¸­è¿›è¡Œæµ®ç‚¹æ•°è¿ç®—æ˜¯å®éªŒæ€§çš„ï¼Œå› ä¸ºè€ƒè™‘åˆ°è·¨å¹³å°é—®é¢˜ï¼Œä¸èƒ½ä¿è¯ç¼–è¯‘æœŸä¸è¿è¡ŒæœŸçš„è¿ç®—ç»“æœå®Œå…¨ä¸€è‡´(è™½ç„¶æœ‰IEEEï¼Œä½†ä¸åŒå¹³å°`NaN behavior`ä¸åŒ)
  >[Must a const fn behave exactly the same at runtime as at compile-time?](https://github.com/rust-lang/rust/issues/77745)
* æ•¬ä½©Rustç¤¾åŒºçš„ä¸¥è°¨æ€åº¦ï¼Œä½†æˆ‘æ²¡æœ‰æ—¶é—´æ·±ç©¶è¿™äº›`issues`, `unstable`å’Œ`experimental`äº†ï¼Œæœ€åè¿˜æ˜¯æ”¾å¼ƒäº†ä½¿ç”¨è¿‡å¤šçš„ç¼–è¯‘æœŸè®¡ç®—

çº¿æ€§æ··åˆå…¬å¼(Blend)(å…¶å®å°±æ˜¯äºŒç»´çº¿æ€§æ’å€¼)ï¼š

$$blendedValue=(1âˆ’t)\cdot startValue+t\cdot endValue$$

`ray_color()`åˆ©ç”¨æ··åˆå…¬å¼çº¿æ€§åœ°å°†ç™½è‰²ä¸å¤©è“è‰²æ··åˆï¼Œä¸»è¦ä»¥ä¸‹å‡ æ­¥:

1. ç¡®å®šåˆ†è¾¨ç‡: å‡å®šå®½åº¦400,æ¯”ä¾‹16:9
2. ç¡®å®šåæ ‡æ˜ å°„ç³»ç»Ÿï¼Œåœºæ™¯å·¦ä¸‹è§’ä¸º(-2,-1,-1)ï¼Œå³ä¸Šè§’ä¸º(2,1,-1)ï¼Œä¸­ç‚¹ä¸º(0,0,-1)ï¼›æ‘„å½±æœº(0,0,0)
3. æŒ‰åƒç´ ä¾æ¬¡å‘å°„å…‰çº¿ã€è®¡ç®—ã€æ··åˆ

æ•ˆæœï¼š
![](./imgs/2023-01-05-17-38-17.png)

### Adding a Sphere
ç»ˆäºè¦æ·»åŠ çœŸæ­£çš„ç‰©ä½“äº†ï¼

è®¡ç®—å…‰çº¿æœ‰æ²¡æœ‰å‡»ä¸­ä¸€ä¸ªçƒä½“å¾ˆç®€å•ï¼Œæ‰€ä»¥ä¸€èˆ¬éƒ½ç”¨çƒä½“æµ‹è¯•å…‰è¿½

#### åˆ¤æ–­å…‰ä¸çƒç›¸äº¤
è®¾Pä¸ºä¸€ä¸ªåæ ‡ç‚¹ï¼ŒCä¸ºçƒå¿ƒåæ ‡ $\vec P=(x,y,z), \vec C =(C_x,C_y,C_z)$ ï¼Œåˆ™Påœ¨Cçƒé¢ä¸Šçš„å…¬å¼ä¸ºï¼š
$$(\vec Pâˆ’\vec C)â‹…(\vec Pâˆ’\vec C)=r^2$$
è‹¥Pä¸ºå…‰çº¿ä¸Šçš„ç‚¹ $\vec P(t)=\vec A+t\vec b$ ,åˆ™ï¼š
$$(\vec P(t )âˆ’\vec C)â‹…(\vec P(t)âˆ’\vec C)=r^2$$
æˆ–è€…æŠŠå…‰çº¿å‡½æ•°æ‰©å±•ä¸ºç‚¹å‘å¼:
$$(\vec A+t\vec bâˆ’\vec C)â‹…(\vec A+t\vec bâˆ’\vec C)=r^2$$
æ•´ç†å¾—åˆ°:
$$\vec b\cdot \vec b \cdot t^2+2\vec b\cdot(\vec Aâˆ’\vec C) \cdot t+(\vec Aâˆ’\vec C)â‹…(\vec Aâˆ’\vec C)âˆ’r^2=0$$
æ˜¯å…³äºtçš„äºŒæ¬¡æ–¹ç¨‹

![](./imgs/2023-01-05-18-08-52.png)

#### å®Œæˆç¬¬ä¸€å¹…å…‰è¿½å›¾åƒ
æ²¡æœ‰ç€è‰²ï¼Œä¹Ÿæ²¡æœ‰åå°„çš„çƒå›¾åƒ
![](imgs/2023-01-05-19-25-51.png)

è¿˜æœ‰ä¸ªbug(ç‰¹æ€§ğŸ˜…)æ˜¯åˆ¤æ–­çƒæ—¶tçš„è§£å¯ä»¥ä¸ºè´Ÿæ•°ï¼Œæ‰€ä»¥å¦‚æœæŠŠçƒzåæ ‡æ”¹æˆ`-1`ä½ ä»ç„¶å¯ä»¥çœ‹åˆ°ä½ èƒŒåçš„çƒ

### Surface Normals and Multiple Objects
#### ç”¨è¡¨é¢æ³•çº¿ç€è‰²
æ³•çº¿æ˜¯åœ¨ç›¸äº¤ç‚¹ä¸Šä¸è¡¨é¢å‚ç›´çš„å‘é‡ã€‚é•¿åº¦æ–¹é¢ï¼Œæ˜¯å•ä½å‘é‡çš„è¯æ¯”è¾ƒæ–¹ä¾¿ç€è‰²ã€‚æ–¹å‘æ–¹é¢ï¼Œå¯¹çƒæ¥è¯´å‘å¤–çš„æ³•çº¿æ˜¯äº¤ç‚¹å‡å»çƒå¿ƒ

å¯è§†åŒ–æ³•çº¿çš„å¸¸ç”¨æŠ€å·§æ˜¯ç›´æ¥æŠŠæ³•çº¿æ–¹å‘æ˜ å°„åˆ°RGBä¸Šã€‚å®ƒå¯¹å•ä½å‘é‡æ³•çº¿æ¥è¯´å¾ˆç®€å•ç›´è§‚ã€‚

![](imgs/2023-01-05-21-14-43.png)

#### ä¼˜åŒ–å…¬å¼

#### æŠ½è±¡å‡ºä¸å…‰çº¿äº¤äº’çš„ç‰©ä½“Object
å½“å‰çƒè¢«ç¡¬ç¼–ç åˆ°`ray_color`ä¸­ï¼Œéš¾ä»¥æ–¹ä¾¿åœ°æ·»åŠ æ›´å¤šç‰©ä½“ï¼Œæ‰€ä»¥éœ€è¦æŠ½è±¡å‡ºèƒ½ä¸å…‰çº¿äº¤äº’çš„ç‰©ä½“ç±»ã€‚åœ¨Rustä¸­æ˜¯ç”¨è¡Œä¸ºæ¥æŠ½è±¡æˆTraitï¼Œå‘½åä¸º`Hittable`

å†…å«æˆå‘˜å‡½æ•°`hit(r: &ray,t_range: &std::ops::Range<f64>) -> Option<HitRecord>`
* `HitRecord`ç”¨äºè®°å½•å…‰æ‰“åœ¨ç‰©ä½“ä¸Šçš„tå€¼ã€æ³•çº¿ã€äº¤ç‚¹ä¸æ³•çº¿æœå‘ä¿¡æ¯(ä»å†…å¾€å¤–è¿˜æ˜¯ä»å¤–å¾€å†…ï¼Œé€šè¿‡å…‰çº¿æ–¹å‘ä¸æœå¤–æ³•çº¿çš„ç‚¹ä¹˜ç»“æœæ¥åˆ¤å®šï¼Œç‚¹ä¹˜å¤§äºé›¶->åŒå‘->æ³•çº¿ä»å†…å¾€å¤–)
* `t_range`èƒ½æ–¹ä¾¿åœ°é™åˆ¶æƒ³è¦ä¸å…‰äº¤äº’çš„ç‰©ä½“åŒºåŸŸèŒƒå›´

å¾ˆå®¹æ˜“ä¸ºçƒä½“å®ç°è¯¥`Trait`

#### `HittableList`
å­˜å‚¨`Hittables`çš„é›†åˆç±»å‹ï¼Œåˆ©ç”¨å¤šæ€ï¼ŒåŒæ—¶å­˜å‚¨ä¸åŒç±»å‹çš„`Hittables`ã€‚åœ¨Rustä¸­ç”¨`Vec<Box<dyn Hitable>>`å­˜å‚¨

åœºæ™¯`World`å°±å¯ä»¥ç”¨ä¸€ä¸ª`HittableList`æ¥è¡¨ç¤ºï¼Œé‡Œé¢æœ‰å¤šä¸ªç‰©ä½“ï¼Œä¸ç”¨æ¯ä¸ªéƒ½åˆ†åˆ«è°ƒç”¨`ray_color`æ¥è·å–é¢œè‰²

### Antialiasing æŠ—é”¯é½¿

çœŸå®çš„ç›¸æœºç”±äºåœ¨ç‰©ä½“è¾¹ç¼˜åƒç´ åŒæ—¶è·å–äº†å‰æ™¯ç‰©ä½“å…‰çº¿å’ŒèƒŒæ™¯å…‰çº¿ï¼Œæ‰€ä»¥ä¸ä¼šæœ‰çªå…€çš„é”¯é½¿ï¼Œè€Œæ˜¯è¿‡æ¸¡æŸ”å’Œè‡ªç„¶ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ä¸€ä¸ªåƒç´ é‡Œæ··åˆå¤šä»½é¢œè‰²é‡‡æ ·æ¥æŠ—é”¯é½¿

#### ä¸€äº›é€šç”¨å‡½æ•°
å…ˆå†™ä¸€ä¸ª`0â‰¤x<1`çš„éšæœºæ•°ç”Ÿæˆå™¨ï¼Œ<1å¾ˆé‡è¦ã€‚
ç”¨Rustçš„`rand crate`å®ç°

#### ç›¸æœºç±» & ç”¨å¤šä»½æ ·æœ¬ç”Ÿæˆåƒç´ 
åœ¨å…‰è¿½ä¸–ç•Œé‡Œï¼Œç›¸æœºæ˜¯ç”¨ä¸»åŠ¨å‘å‡ºå…‰çº¿ç„¶åè·å–å…‰çº¿ä¸ç‰©ä½“äº¤äº’ä¿¡æ¯çš„å½¢å¼æ¥æ¨¡æ‹ŸçœŸå®ä¸–ç•Œä¸­ç›¸æœºæ¥æ”¶å…‰çº¿çš„ã€‚ç›¸æœºéœ€è¦æ¨ªçºµæ¯”ï¼Œåœºæ™¯èŒƒå›´å’Œèµ·ç‚¹ä¿¡æ¯ã€‚é‡‡ç”¨æµ®ç‚¹æ•°åœºæ™¯åæ ‡è€Œéåƒç´ åæ ‡ã€‚å¯ä»¥éšæ„æŒ‡å®šåƒç´ æ•°é‡ã€‚éœ€è¦`get_ray`æ–¹æ³•æ¥ç”Ÿæˆå…‰çº¿

åœ¨åŸæœ‰åƒç´ åæ ‡è®¡ç®—å‡ºåœºæ™¯åæ ‡çš„å‘¨å›´éšæœºç”Ÿæˆé‡‡æ ·ç‚¹åæ ‡ï¼Œè¿›è¡Œé‡‡æ ·åå¹³å‡æˆæœ€ç»ˆé¢œè‰²

### Diffuse(Matte) Materials
æ¼«åå°„(æ— å…‰æ³½ï¼›ç£¨ç ‚)æè´¨ç‰¹æ€§ï¼š
* ä¸æ˜¯åƒé•œé¢åå°„ä¸€æ ·åªå‘ˆç°å‡ºå‘¨å›´ç¯å¢ƒçš„é¢œè‰²ï¼Œè€Œæ˜¯ç”¨è‡ªå·±å›ºæœ‰çš„é¢œè‰²æ¥è°ƒèŠ‚è¿™ç§é¢œè‰²
* å¯¹å…‰çº¿å¸æ”¶ç‡è¾ƒé«˜ï¼Œæ˜¾å¾—è¾ƒæš—
* åªè¦åå°„å…‰çº¿æ–¹å‘éšæœºå°±èƒ½å®ç°æ¼«åå°„æ•ˆæœã€‚
 
å…ˆå®ç°æœ€ç®€å•çš„ç†æƒ³æ¼«åå°„è¡¨é¢æ¨¡å‹(ideal diffuse surfaces)ï¼Œå®ƒæ˜¯`Lambertian`åå°„(ç†æƒ³æ•£å°„)æ¨¡å‹çš„ç®€åŒ–å®ç°(simple hack,inaccurate)
* Lambertianè¡¨é¢æ˜¯æŒ‡åœ¨ä¸€ä¸ªå›ºå®šçš„ç…§æ˜åˆ†å¸ƒä¸‹ä»æ‰€æœ‰çš„è§†åœºæ–¹å‘ä¸Šè§‚æµ‹éƒ½å…·æœ‰ç›¸åŒäº®åº¦çš„è¡¨é¢ï¼ŒLambertianè¡¨é¢ä¸å¸æ”¶ä»»ä½•å…¥å°„å…‰ï¼Lambertianåå°„ä¹Ÿå«æ•£å…‰åå°„ï¼Œä¸ç®¡ç…§æ˜åˆ†å¸ƒå¦‚ä½•ï¼ŒLambertianè¡¨é¢åœ¨æ‰€æœ‰çš„è¡¨é¢æ–¹å‘ä¸Šæ¥æ”¶å¹¶å‘æ•£æ‰€æœ‰çš„å…¥å°„ç…§æ˜ï¼Œç»“æœæ˜¯æ¯ä¸€ä¸ªæ–¹å‘ä¸Šéƒ½èƒ½çœ‹åˆ°ç›¸åŒæ•°é‡çš„èƒ½é‡ï¼

![](imgs/2023-01-10-22-30-41.png)
åœ¨æ³•å‘é‡é•¿åº¦ä¸ºåŠå¾„ï¼Œå…‰çº¿ä¸ç‰©ä½“äº¤ç‚¹+æ³•å‘é‡ä¸ºçƒå¿ƒçš„çƒä¸Šéšæœºå–ç‚¹ï¼Œç”Ÿæˆåå°„å…‰çº¿

åå°„å…‰çº¿ä½¿`ray_color`å˜ä¸ºäº†é€’å½’å‡½æ•°ï¼Œä¸å°„åˆ°ä»»ä½•ç‰©ä½“æ‰ä¼šç»“æŸé€’å½’ã€‚æ‰€ä»¥æ­¤å¤–æˆ‘ä»¬è¿˜éœ€è¦é™åˆ¶é€’å½’çš„æœ€å¤§å±‚æ•°

#### ç”¨ä¼½é©¬çŸ«æ­£ç²¾ç¡®çš„é¢œè‰²å¼ºåº¦
>[ä¼˜ç§€å‚è€ƒèµ„æ–™ï¼šåˆ°åº•ä»€ä¹ˆæ˜¯ä¼½é©¬æ ¡æ­£ Gamma Correction?](https://zhuanlan.zhihu.com/p/33637724)
>[ç®€æ˜“èµ„æ–™ï¼šä¼½é©¬çŸ«æ­£ä¸LUT](https://blog.csdn.net/dx199771/article/details/111504446)

æ˜¾ç¤ºå™¨éƒ½å‡è®¾å›¾åƒæ˜¯ç»è¿‡ä¼½é©¬çŸ«æ­£çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿéœ€è¦å°†åŸå§‹å›¾åƒè¿›è¡Œä¼½é©¬çŸ«æ­£æ¥å¾—åˆ°æ­£å¸¸çš„æ˜¾ç¤ºæ•ˆæœã€‚æˆ‘ä»¬é€‰æ‹©ç®€æ˜“çš„`gamma 2`,åªéœ€å¯¹åŸå§‹é¢œè‰²(`[0,1)`)å¼€å¹³æ–¹æ ¹ï¼Œå†æ˜ å°„åˆ°`[0,255]`å³å¯

#### Fixing Shadow Acne
ä¸ºäº†æ¶ˆé™¤é˜´å½±çš„æ¯›åˆºï¼Œéœ€è¦å¿½ç•¥tååˆ†æ¥è¿‘0(ä¸è‡ªå·±ç›¸äº¤)çš„å°„çº¿

#### çœŸæ­£çš„Lambertian Reflection
å®ç°ä¸Šçš„åŒºåˆ«åªæ˜¯æŠŠåœ¨çƒä¸­ç”Ÿæˆçš„éšæœºå‘é‡å•ä½åŒ–äº†ï¼Œä½†å…·ä½“åŸç†æ²¡æ‡‚

æ•ˆæœï¼š
* é˜´å½±æ·¡äº†ä¸€äº›
* çƒçš„é¢œè‰²æ›´æµ…äº†

è¿™ä¸¤ç§å˜åŒ–éƒ½æ˜¯ç”±äºå…‰çº¿çš„æ•£å°„æ›´åŠ å‡åŒ€ï¼Œæ›´å°‘çš„å…‰çº¿å‘æ³•çº¿æ•£å°„ã€‚
* å¯¹äºæ¼«åå°„çš„ç‰©ä½“ï¼Œå®ƒä»¬ä¼šæ˜¾å¾—æ›´æµ…ï¼Œè¿™æ˜¯å› ä¸ºæœ‰æ›´å¤šçš„å…‰åå°„åˆ°ç›¸æœºä¸Šã€‚
* å¯¹äºé˜´å½±ï¼Œå‘ä¸Šåå°„çš„å…‰çº¿è¾ƒå°‘ï¼Œå› æ­¤æ­£å¤„äºè¾ƒå°çƒä½“ä¸‹æ–¹çš„å¤§çƒéƒ¨åˆ†æ›´äº®ã€‚

### é‡‘å±æè´¨&é•œé¢åå°„ Mirrored Light Reflection
#### å¯¹ææ–™çš„æŠ½è±¡
ææ–™å¯ä»¥é€‰æ‹©å’Œå…·ä½“ç‰©ä½“ç»‘å®šï¼Œä¹Ÿå¯ä»¥ä¸ç»‘å®šã€‚è¿™é‡Œå°±ä¸ç»‘å®šäº†ï¼Œè€Œæ˜¯ç‰©ä½“æŒæœ‰æè´¨çš„`Rc`æ™ºèƒ½æŒ‡é’ˆ

ææ–™éœ€è¦å¤„ç†ä¸¤ä¸ªé—®é¢˜ï¼š
1. å¦‚ä½•åˆ›é€ åå°„/æ•£å°„å…‰(å³å¦‚ä½•å¸æ”¶ã€è½¬åŒ–å…¥å°„å…‰)
2. å…‰çº¿è¡°å‡é‡å¦‚ä½•

diffuse:
1. è§†çº¿ä¸ç‰©ä½“è¡¨é¢äº§ç”Ÿæ’å‡»ç‚¹pï¼Œåœ¨på¤„ç›¸åˆ‡å•ä½åœ†å†…éšæœºæ‰¾ä¸€ç‚¹sï¼Œæ•£å°„å…‰æ–¹å‘å³p->s
2. å…‰çº¿å¼ºåº¦è¡°å‡ä¸€åŠ(Colorç›´æ¥ä¹˜0.5ï¼Œçº¢ç»¿è“åŒæ—¶å‡å°‘ä¸€åŠï¼Œç›¸å½“äºåªå‡å°å…‰å¼ºä¸æ”¹å˜é¢œè‰²ï¼Œæœ€åå‘ˆä¸­æ€§ç°è‰²)

metal:
1. é•œé¢åå°„ï¼Œæ ¹æ®åå°„å®šå¾‹ï¼Œç”±å…¥å°„å…‰ç›´æ¥ç¡®å®šåå°„å…‰æ–¹å‘
2. çº¢ç»¿è“è¡°å‡ç¨‹åº¦ä¸åŒï¼Œä½¿ä¸åŒé‡‘å±å‘ˆç°ä¸åŒé¢œè‰²ã€‚ç”¨å‚æ•°è‡ªç”±ç¡®å®š

![](imgs/2023-01-11-23-23-22.png)
ç”±äºæˆ‘ä»¬çš„æ³•å‘é‡æ˜¯å•ä½å‘é‡ï¼Œæ‰€ä»¥ $|\vec b| = \vec v * \vec n$
å…¬å¼: å‡ºå°„å…‰çº¿ $\vec o = \vec v - 2\vec n \times (\vec v\cdot \vec n)$

##### å®ç°ç»†èŠ‚
å®ç°äº†`Material trait`çš„`struct`æ˜¯ä¸€ç§ææ–™ï¼Œå®ƒçš„`scatter`æ–¹æ³•å¯ä»¥é€šè¿‡`å…¥å°„å…‰`ä¸`HitRecord`ç¡®å®šå‡ºå°„å…‰ä¸å…¶é¢œè‰²ã€‚é€šè¿‡å‰è¿°æ–¹æ³•åˆ†åˆ«å®ç°`Lambertian`ä¸`Matel`

é—®é¢˜ï¼šæ¼«åå°„æŠ½è±¡æ—¶å¯èƒ½äº§ç”Ÿçš„åå°„å…‰ä¸æ³•çº¿æ¥è¿‘åå‘ï¼ŒåŠ èµ·æ¥æ¥è¿‘0å¯¼è‡´`NaN`æˆ–è€…`Inf`
è§£å†³æ–¹æ¡ˆï¼šç‰¹åˆ¤æ¥è¿‘é›¶çš„æƒ…å†µï¼Œè¿”å›æ³•çº¿æ–¹å‘

ç‰©ä½“ä¸`HitRecord`éƒ½æŒæœ‰æè´¨çš„å…±äº«å‹æ™ºèƒ½æŒ‡é’ˆ

ä¿®å¤ä¹‹å‰`impl Mul<Vec3> for Vec3`çš„ä¸¥é‡bug

#### Fuzzy Reflection æ¨¡ç³Šåå°„
ç°å®çš„é‡‘å±å¾ˆéš¾åšåˆ°åƒé•œå­ä¸€æ ·ç²¾å‡†åœ°åå…‰ï¼Œè€Œæ˜¯æœ‰ä¸€å®šçš„æ¨¡ç³Šæ•ˆæœã€‚å¯¹é•œé¢åå°„å‡ºå°„æ–¹å‘è¿›è¡Œå°‘é‡çš„éšæœºæ‰°åŠ¨ï¼Œè·å¾—æ¨¡ç³Šåå°„æ•ˆæœ

### Dielectrics & Refraction
Dielectricsï¼šç”µä»‹è´¨ï¼Œå¦‚ç©ºæ°”ã€ç»ç’ƒã€æ°´ã€é’»çŸ³ã€‚

å¯¹äºå…‰(å±äºç”µç£æ³¢)æ¥è¯´ï¼Œä¼ æ’­ä¸éœ€è¦ä»»ä½•ä»‹è´¨ï¼Œæ‰€ä»¥åœ¨çœŸç©ºé‡Œä¹Ÿå¯ä»¥ä¼ æ’­ã€‚

åœ¨ä¸åŒç”µä»‹è´¨ä¸­çš„ä¼ æ’­ä¸çœŸç©ºä¸­ä¼ æ’­æœ‰æ‰€ä¸åŒï¼Œå¦‚ï¼š
* åœ¨è¶Šç¨€ç–çš„ä»‹è´¨ä¸­ä¼ æ’­é€Ÿåº¦è¶Šå¿«
* ä»ä¸€ç§ä»‹è´¨æ–œå°„å…¥å¦ä¸€ç§ä»‹è´¨æ—¶ï¼Œç”±äºæƒ æ›´æ–¯åŸç†/å…‰å’Œç‰©è´¨é—´çš„ç›¸äº’ä½œç”¨åŠ›(è¿‘ä»£ç‰©ç†)ï¼Œä¼šåœ¨äº¤ç•Œå¤„å‘ç”ŸåæŠ˜ï¼Œä¼ æ’­æ–¹å‘æ”¹å˜ï¼Œè¿™ç§ç°è±¡å³ä¸ºæŠ˜å°„(Refraction)

å…‰å‡»ä¸­ç”µä»‹è´¨è¡¨é¢æ—¶æ—¢ä¼šæŠ˜å°„è¿›å…¥ä»‹è´¨ï¼Œåˆä¼šåå°„è€Œç¦»å¼€ä»‹è´¨ï¼Œä½†æˆ‘ä»¬çš„ä¸€æŸå…‰çº¿åªèƒ½é€‰æ‹©å…¶ä¸€ï¼Œæ‰€ä»¥æˆ‘ä»¬éšæœºé€‰æ‹©æŠ˜å°„æˆ–åå°„ä¹‹ä¸€ä½œä¸ºæ•£å°„æ–¹å¼ï¼Œç»è¿‡å¤šæ¬¡å–æ ·çš„å¹³å‡ï¼Œæœ€ç»ˆæ•ˆæœç›¸åŒ

#### æŠ˜å°„
æ–¯æ¶…å°”å®šå¾‹(Snell's Lawï¼ŒæŠ˜å°„å®šå¾‹)ï¼š
$$\eta_1\sin \theta_1 = \eta_2\sin \theta_2$$

å…¶ä¸­ $\theta_1$ ä¸ºå…¥å°„è§’ï¼Œ $\theta_2$ ä¸ºæŠ˜å°„è§’ï¼Œ $\eta_1$  $\eta_2$ åˆ†åˆ«æ˜¯ä¸¤ç§ä»‹è´¨çš„æŠ˜å°„ç‡( $\geq 1$ )
![](imgs/2023-01-12-12-46-33.png)
ç»ç’ƒ1.3~1.7ï¼Œé’»çŸ³2.4

è®¡ç®—æŠ˜å°„è§’ï¼š

$$\sin \theta_2 = \frac {\eta_1} {\eta_2}\sin \theta_1$$

é¦–å…ˆå…¥å°„å…‰ã€æ³•çº¿ã€æŠ˜å°„å…‰ã€(åå°„å…‰)éƒ½åœ¨ä¸€ä¸ªå¹³é¢å†…ã€‚æˆ‘ä»¬å¯ä»¥åœ¨å¹³é¢ä¸Šå°†æŠ˜å°„å…‰`R'`åˆ†è§£æˆä¸¤ä¸ªå‚ç›´çš„éƒ¨åˆ†æ¥è®¡ç®— 

$$\vec R'=\vec {R'_\perp}+\vec {R'_\parallel}$$

å¯ä»¥è§£å‡º 

$$\vec {R'_\perp}=\frac {\eta_1} {\eta_2}(\vec R+\cos \theta_1 \vec n),$$

$$\vec {R'_\parallel} = - \sqrt{1- |\vec {R'_\perp}|^2}\vec n,$$

å…¶ä¸­ $\cos \theta = \frac {\vec a \cdot \vec b} {|\vec a| |\vec b|}$ ï¼Œå¯å°†å…¬å¼åŒ–ä¸º

$$\vec {R'_\perp}=\frac {\eta_1} {\eta_2}(\vec R+(-\vec R \cdot \vec n)\vec n)$$

#### å…¨åå°„
å…¨åå°„ä¸ä¸´ç•Œè§’ï¼šæŠ˜å°„ç‡å¤ªå¤§ä¼šå¯¼è‡´Snell's Lawæ²¡æœ‰å®æ ¹ï¼Œå³æ²¡æœ‰æŠ˜å°„å¯èƒ½ï¼Œåªä¼šåå°„ï¼Œè¿™å°±æ˜¯å…¨åå°„ã€‚æŠ˜å°„è§’å…¬å¼ï¼š

$$\sin \theta_2 = \frac {\eta_1} {\eta_2}\sin \theta_1$$

å…¬å¼ä¸­å¦‚æœ $\eta_1=1.5, \eta_2=1.0, \sin \theta_1>\frac 2 3$ æ—¶ $\sin \theta_1>1$ ï¼ŒæŠ˜å°„è§’æ— è§£,å‘ç”Ÿå…¨åå°„

#### Schlick Approximation
ç°åœ¨æˆ‘ä»¬çš„ç”µä»‹è´¨è¦ä¹ˆåªæŠ˜å°„å…‰çº¿ï¼Œè¦ä¹ˆåªå…¨åå°„å…‰çº¿ã€‚å®é™…ä¸Šçš„ç”µä»‹è´¨æ ¹æ®å…¥å°„è§’åº¦ä¼šæœ‰ä¸åŒçš„æŠ˜å°„ä¸åå°„æ¯”ä¾‹ï¼Œè€Œä¸æ˜¯äºŒè€…åªæ‹©å…¶ä¸€ã€‚

There is a big ugly equation for that, but almost everybody uses a cheap and surprisingly accurate polynomial approximation by Christophe Schlick. 

#### å»ºæ¨¡ç©ºå¿ƒç»ç’ƒçƒ
ç”µä»‹è´¨çš„ä¸€ä¸ªæœ‰æ„æ€ä¸”ç®€å•çš„èŠ±æ ·å°±æ˜¯ç©ºå¿ƒç»ç’ƒçƒï¼Œå¦‚æœåŠå¾„ä¸ºè´Ÿæ•°ï¼Œçƒçš„ç©ºé—´èŒƒå›´æ²¡æœ‰æ”¹å˜ï¼Œä½†è¡¨é¢çš„æ³•å‘é‡åå‘äº†ï¼Œè¿™å¯ä»¥ç”¨æ¥åœ¨çƒé‡Œæ‰“ä¸€ä¸ªç©ºæ°”æ³¡ã€‚

### Positionable Camera
è®©ç›¸æœºå¯ä»¥ç§»åŠ¨ã€æ—‹è½¬ã€ç¼©æ”¾

ç›¸æœºå’Œç”µä»‹è´¨éƒ½å¾ˆéš¾è°ƒè¯•(ç¡®å®)ã€‚æ‰€ä»¥åº”å½“æ¸è¿›å¼åœ°å¼€å‘ã€‚å…ˆå…è®¸è§†é‡/è§†åœºè§’(FOV,Field of View)å¯ä»¥è°ƒèŠ‚ï¼›å†å¼€å‘ä½ç§»å’Œæ—‹è½¬ã€‚

FOVæ¨ªå‘å’Œçºµå‘ä¸åŒï¼Œä»¥æ¨ªå‘ä¸ºåŸºå‡†ï¼Œçºµå‘å¯¹æ¨ªå‘ä¹˜ä¸€ä¸ªæ´—æ¼±ã€‚

#### Camera Viewing Geometry
å…ˆè®©ç›¸æœºå¯¹å‡†zè½´è´Ÿæ–¹å‘ï¼Œhä½œä¸ºå‘é‡ä¸zè½´çš„è·ç¦»

![](imgs/2023-01-13-19-18-32.png)
(å›¾ç‰‡ä¸å¤Ÿç›´è§‚ï¼Œ $\theta$ è§†åœºè§’æ˜¯ä¸¤å€ä¸zè½´çš„å¤¹è§’ï¼Œæ‰€ä»¥è®¡ç®—tanè¦é™¤ä»¥2, $h = \tan {(\frac \theta 2)}$ )

#### Positioning and Orienting the Camera
`look_from`ç‚¹åˆ°`look_at`ç‚¹ï¼ŒåŠ ä¸Š`view_up`ä»£è¡¨ç›¸æœºæŒ‡å‘ä¸Šæ–¹æ–¹å‘çš„å‘é‡ï¼Œç¡®å®šäº†ä¸€ä¸ªç›¸æœºçš„ä½ç½®ã€æœå‘ä¸æ—‹è½¬è§’åº¦ï¼›å†åŠ ä¸Šä¹‹å‰çš„è§†åœºè§’`vfov`å°±èƒ½ç¡®å®šè·å–å›¾åƒçš„èŒƒå›´

![](imgs/2023-01-14-17-10-39.png)
ç”¨å®ƒä»¬ç®—å‡ºu,v,w,æœ€ç»ˆç®—å‡º`origin`ã€`horizontal`ã€`vertical`ã€`lower_left_corner`è¿™äº›å˜é‡

### Defocus Blur
æˆ‘ä»¬ç°åœ¨çš„å…‰çº¿éƒ½ä»`look_from`å‘å‡ºï¼Œç›¸å½“äºæˆåƒåˆ°äº†ä¸€ä¸ªè´¨ç‚¹ä¸Šï¼Œä¸ä¼šæœ‰ä»»ä½•æ™¯æ·±æ¨¡ç³Šæ•ˆæœã€‚ä¸ºäº†æ¨¡æ‹Ÿæ™¯æ·±æ¨¡ç³Šæ•ˆæœå¯ä»¥è®©å…‰çº¿ä»ä¸(`look_at-look_from`)å‘é‡å‚ç›´çš„å¹³é¢ä¸Šçš„ ä»¥`look_from`ä¸ºåœ†å¿ƒçš„åœ†é‡Œéšæœºé€‰ä¸€ç‚¹è¿›è¡Œå‡ºå°„ã€‚å‡ºå°„åˆ°ç„¦å¹³é¢(focus plane)ä¸Šï¼Œè¿™ä¸ªå¹³é¢ä¸Šçš„ç‰©è±¡éƒ½æ˜¯å®Œå…¨æ¸…æ™°çš„ã€‚

å®é™…æ˜¯æ¨¡æ‹Ÿäº†çœŸå®ç›¸æœºçš„ä¸€åŠï¼šåªæ¨¡æ‹Ÿé•œå¤´ä¹‹å¤–çš„éƒ¨åˆ†ï¼Œè€Œæ²¡æœ‰å¿…è¦æ¨¡æ‹Ÿé•œå¤´å†…çš„éƒ¨åˆ†
![](imgs/2023-01-14-19-46-33.png)

### æˆæœ
![](imgs/2023-01-14-22-38-27.png)
![](imgs/2023-01-14-22-38-49.png)

from 
![](imgs/2023-01-15-22-45-39.png)
to
![](imgs/2023-01-15-22-45-57.png)
using Rayon

#### äº¤æµ
[Remdaï¼š3æœ¬,Rust,Rayonå¹¶è¡Œä¼˜åŒ–](https://rustcc.cn/article?id=bffdbc8b-1c99-4d1d-942c-91365b6ada0d)
[fralken: 3æœ¬,Rust,Rayonå¹¶è¡Œä¼˜åŒ–](https://github.com/fralken/ray-tracing-in-one-weekend)
[Rust, high-performance](https://github.com/skyzh/raytracer.rs/)
[Writing About Ray Tracing in One Weekend with Rust Blog](https://andy.stanton.is/writing/about/ray-tracing-in-one-weekend/)
[How can I share immutable data between threads in Rust?](https://stackoverflow.com/questions/62744175/how-can-i-share-immutable-data-between-threads-in-rust?r=SearchResults)
#### è¿›æ­¥
[å¤šçº¿ç¨‹ç¼–ç¨‹çš„ç§˜å¯†ï¼šSync, Send, and 'Static](https://zhuanlan.zhihu.com/p/362285521)
[Rayon å¹¶è¡Œä¼˜åŒ–](https://developers.redhat.com/blog/2021/04/30/how-rust-makes-rayons-data-parallelism-magical#generic_constraints_in_rayon)
[BVHåœºæ™¯ç®¡ç†åŠ é€Ÿå…‰çº¿è¿½è¸ª](https://blog.icysky.site/archives/164)
[BVH](https://blog.csdn.net/m0_56399931/article/details/124145240)

### æ€»ç»“
#### ã€ŠRay Tracing in One Weekendã€‹ä¹‹æ—…
åœ¨è¢«ä¸­é—´ä¸€æ¬¡æ—…æ¸¸æ‰“æ–­çš„æ€»å…±èŠ±äº†ä¸€å‘¨çš„ã€ŠRay Tracing in One Weekendã€‹ä¹‹æ—…ä¸­æˆ‘èµ°è¿›äº†å…‰çº¿è¿½è¸ªçš„ä¸–ç•Œï¼š
* ä»é•œå¤´é‡Œå°„å‡ºå…‰çº¿ï¼Œå†é€šè¿‡å…‰è·¯å¯é€†åŸç†å¾—åˆ°è¿›å…¥é•œå¤´å°„åˆ°æŸä¸ªåƒç´ ç‚¹ä¸Šçš„å…‰çº¿é¢œè‰²ï¼›
* çœ‹ä¼¼ç®€å•å´åˆæœ‰è®¸å¤šé—¨é“çš„éšæœºèƒ½äº§ç”Ÿå‡ºæ¼«åå°„çº¹ç†ï¼›
* å…‰æºä¸æ¥è§¦ç‰©ä½“é¢œè‰²RGBåˆ†åˆ«ç›¸ä¹˜å¾—åˆ°çš„å°±æ˜¯å®ƒä»¬â€œæ··åˆâ€å‡ºçš„é¢œè‰²(å› ä¸ºç‰©ä½“æœ¬èº«å¸¸å¸¸å‘ˆç°çš„é¢œè‰²å…¶å®æ˜¯å®ƒå¯¹ä¸åŒæ³¢é•¿å…‰çº¿çš„å‡ºå°„ç‡å†³å®šçš„)ã€‚å…¶å®å¯¹åº”PSé‡Œçš„"**æ­£ç‰‡å åº•**"
* å„ç§æ•°å­¦å…¬å¼æ¨å¯¼ï¼ŒåŒ…æ‹¬ç›¸å¯¹æ¯”è¾ƒå¤æ‚çš„æŠ˜å°„ä¸å…¨åå°„ï¼›
* `Schlick's approximation`ç­‰ç¥å¥‡çš„hackæ“ä½œÂ·Â·Â·Â·Â·Â·
![](imgs/2023-01-16-14-21-23.png)

#### Rust è¯­è¨€
è¿™ä¸ªé¡¹ç›®å¯¹æˆ‘çš„Rustæ¥è¯´ä¹Ÿç®—æ˜¯ä¸€æ¬¡è¶…çº²æ¼”ç»ƒã€‚ç¢°åˆ°äº†ä¸å°‘è¯¾æœ¬ä¸Šä¸ä¼šå‡ºç°çš„å¤æ‚æˆ–æ€ªå¼‚çš„é—®é¢˜ï¼š
* å„ç§è‡ªå®šä¹‰ç±»å‹åˆ°åº•åº”è¯¥é€‰æ‹©`Copy`&`Clone`è¿˜æ˜¯`Move`(`Copy`ä¸`Clone`ä¹Ÿæ··æ·†äº†ï¼Œå¾€å¾€å°†ä¸¤ä¸ªç»‘å®šåœ¨äº†ä¸€èµ·)ï¼›
* `match`ä¸­å‡ºç°æµ®ç‚¹æ•°å­—é¢é‡æ˜¯ä¸å—æ”¯æŒçš„è¡Œä¸º(åŒ…æ‹¬çœ‹èµ·æ¥æ— æ¯”è‡ªç„¶çš„`Range`)ï¼›è¿™ä¸ªè¿½è¸ªäº†å¥½ä¹…ç›¸å…³issueï¼Œäº†è§£åˆ°å®ƒæ— æ³•è¢«æ”¯æŒçš„çš„ä¸€äº›å¤æ‚åŸå› ï¼Œå’Œæš‚æ—¶(æˆ–è®¸æ°¸è¿œ)ä¸ä¼šè¢«å¼ƒç”¨çš„æ¶ˆæ¯ï¼Œä½†ä¸ºäº†ä¸æŠ¥è­¦å‘Šè¿˜æ˜¯ç”¨åŒ¹é…å®ˆå«æ›¿ä»£äº†å®ƒ
* `Box<dyn T>`æ‰“åŒ…ä¸`&dyn T`+ç”Ÿå‘½å‘¨æœŸ`lifetime`ç®¡ç†çš„å€Ÿç”¨ä¹‹é—´åˆ°åº•å¦‚ä½•é€‰æ‹©ï¼›
* å¤šæ€åˆ°åº•é€‰æ‹©æ³›å‹`generic`(`impl Trait`æ˜¯å…¶è¯­æ³•ç³–ï¼Œå®é™…å°±æ˜¯é™æ€åˆ†å‘)ï¼Œè¿˜æ˜¯`dyn Trait Object`åŠ¨æ€åˆ†å‘ï¼Œè¿˜æ˜¯æ¯”è¾ƒå°‘è§çš„`enum+struct`ã€‚å®ƒä»¬ä¹‹é—´åˆ°åº•æœ‰ä»€ä¹ˆæœ¬è´¨åŒºåˆ«ï¼Œä»€ä¹ˆåœºæ™¯æ›´é€‚åˆé€‰æ‹©ä»€ä¹ˆï¼›
* å¿˜è®°äº†`trait`å¯ä»¥ç»§æ‰¿(å®é™…ä¸Šç›¸æ¯”ç»§æ‰¿æ›´åº”è¯¥çœ‹ä½œ**å‰ç½®ä¾èµ–**)ï¼Œå¯¼è‡´å¹¶å‘æ—¶`trait object`ç¼ºå°‘`Sync&Send`æ ‡è®°`Trait`è€Œéœ€è¦åœ¨å‚æ•°é‡Œå†™æ— æ•°é`&dyn Hittable + Send + Sync`
Â·Â·Â·Â·Â·Â·

æ‰€ä»¥ç°åœ¨å°±æ˜¯ä¸€ä¸ªæ€»ç»“æå‡Rustçš„è‰¯æœº
##### Copyä¸Clone
`Copy`: å‘ç¼–è¯‘å™¨è¯´æ˜è¯¥ç±»å‹çš„è¯­ä¹‰ï¼Œä¸`Move`ç›¸åï¼›ä»£è¡¨é‡æ–°ç»‘å®šè¡Œä¸ºæ—¶(åŒ…æ‹¬`let`ã€å‡½æ•°ä¼ å‚)çš„é»˜è®¤è¡Œä¸ºåº”è¯¥æ˜¯ï¼š`Clone`ä¸€ä»½å‰¯æœ¬ï¼ŒåŸæ¥çš„ç»‘å®šä»æœ‰æ•ˆï¼›è¿˜æ˜¯`Move`ç§»äº¤æ‰€æœ‰æƒï¼ŒåŸæ¥çš„ç»‘å®šå¤±æ•ˆ

`Clone`: `#[derive(Clone)]`å‘ç¼–è¯‘å™¨è¯´æ˜è¯¥ç±»å‹å¯ä»¥é€æ¯”ç‰¹æ‹·è´ï¼Œå¹¶ç”Ÿæˆé»˜è®¤å®ç°ï¼›æˆ–è€…æ‰‹åŠ¨å®ç°è¯­ä¹‰ç›¸åŒè€Œå®é™…è¡Œä¸ºå¯èƒ½ä¸åŒçš„`Clone`æ“ä½œ(å¦‚`Rc`çš„`Clone`å®é™…æ˜¯å¼•ç”¨è®¡æ•°+1; `Box`çš„`Clone`å®é™…æ˜¯æ·±æ‹·è´)

##### é¢å‘å¯¹è±¡ & å¤šæ€
`Rust`çš„é¢å‘å¯¹è±¡ç‰¹æ€§åœ¨è¿™ä¸ªé¡¹ç›®æ¥çœ‹æ˜¯å¾ˆå¤Ÿç”¨çš„ï¼Œå’Œå†™C++æ²¡å¤ªå¤§å·®åˆ«ã€‚
è‡³äºåˆ°åº•ç”¨æ³›å‹è¿˜æ˜¯åŠ¨æ€å¤šæ€ï¼ŒåŠ¨æ€å¤šæ€ çµæ´»/æ‹“å±•æ€§æ›´å¼ºï¼Œçœç©ºé—´ï¼›æ³›å‹é€Ÿåº¦æ›´å¿«ï¼Œè€ŒäºŒè¿›åˆ¶ä»£ç ä¼šæ›´å¤§ï¼›ä½†ç°åœ¨çš„ä»£ç æ¥çœ‹åŒºåˆ«ä¸å¤§

##### å¹¶å‘
`Sync`ï¼šå¯¹è±¡å¯ä»¥å®‰å…¨åœ°åœ¨çº¿ç¨‹é—´é€šè¿‡ä¸å¯å˜å€Ÿç”¨(å¯å˜å€Ÿç”¨ä¸å¯èƒ½çº¿ç¨‹å®‰å…¨)æ¥å…±äº«(æœªå®ç°å®ƒçš„åä¾‹ï¼š`Rc`ï¼›`Cell`)

`Send`ï¼šå¯¹è±¡å¯ä»¥å®‰å…¨åœ°åœ¨çº¿ç¨‹ä¹‹é—´ä¼ é€’æ‰€æœ‰æƒ(æœªå®ç°å®ƒçš„åä¾‹ï¼š`Rc`çš„å¼•ç”¨è®¡æ•°æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œæ‰€ä»¥æ— æ³•å®ç°å…±äº«æ‰€æœ‰æƒï¼Œéœ€è¦ç”¨`Arc`)

`&T`å®ç°äº†`Send` ç­‰ä»·äº `T`å®ç°äº†`Sync`

è¿™é‡Œå…¶å®è¿˜æ˜¯æ²¡æœ‰å®Œå…¨ææ‡‚ï¼Œå› ä¸ºè¿˜æ¶‰åŠé”(`Mutexâ€‹`)ã€å†…éƒ¨å¯å˜æ€§(`Cell`ã€`â€‹RefCell`)ç­‰é—®é¢˜ï¼›æš‚æ—¶æ²¡æœ‰ç ”ç©¶

##### crates
`Image`: éå¸¸ä¸æ»‘ï¼Œç°åœ¨å¯ä»¥ç”Ÿæˆ`png`æ¥ä»£æ›¿ä¹‹å‰çš„`ppm`äº†

`Rayon`: å¼„æ‡‚`Sync``Send`ä¸`Trait`ç»§æ‰¿ä»¥åéå¸¸ä¸æ»‘ï¼Œè®©é‡‡æ ·è¿‡ç¨‹è½»æ˜“åœ°å¹¶è¡ŒåŒ–ï¼Œæé€Ÿæ˜¾è‘—

`cargo`éå¸¸æ£’ï¼Œä½†ç¼–è¯‘é›€é£Ÿæ…¢...

#### ä¸‹ä¸€æ­¥
ç¨å¾®çœ‹äº†çœ‹åé¢çš„æ·»åŠ å…‰æºã€æ·»åŠ å½¢çŠ¶ã€æè´¨ã€åŠ¨æ€æ¨¡ç³Šã€BVHåŠ é€Ÿ(å…‰çº¿è¿½è¸ªç¡¬ä»¶å•å…ƒçš„åŸºç¡€)ç­‰å†…å®¹ã€‚ä½†ç°åœ¨æœ‰ç¼“è€ƒç§‘ç›®å’ŒCPCå¯’å‡é›†è®­çš„å‹åŠ›åº”è¯¥æš‚æ—¶ä¸ä¼šå¼€å‘äº†ã€‚

# Ray Tracing the Next Week Notes
[The Next Weekç¬”è®°(ä¸Šç¯‡)](https://zhuanlan.zhihu.com/p/44503768)
[The Next Weekç¬”è®°(ä¸‹ç¯‡)](https://zhuanlan.zhihu.com/p/48643909)
[éš¾ç‚¹](https://zhuanlan.zhihu.com/p/80108202)

in one weekend çš„é—®é¢˜ï¼š
* åªæœ‰çƒä½“->å¼•å…¥çŸ©å½¢
* åªæœ‰ç¯å¢ƒå…‰æº(è“è‰²æ¸å˜èƒŒæ™¯ä½œä¸ºå…‰æº)->æ·»åŠ ç‚¹å…‰æºç­‰å…‰æº
* æ€§èƒ½å¤ªä½(`hittable_list`->å±‚æ¬¡åŒ…å›´ç›’`BVH,Bounding Volume Hierarchies`)
* åªèƒ½é™ç‰©->å¼•å…¥æ—¶é—´å˜é‡ã€åŠ¨æ€æ¨¡ç³Šæ•ˆæœ
* åªæœ‰å‡ºå°„æ•ˆæœï¼Œæ²¡æœ‰çº¹ç†->å¼•å…¥çº¹ç†è´´å›¾ã€æŸæ—å™ªå£°çº¹ç†
* æ²¡æœ‰ä½“ç§¯æ¸²æŸ“->æ·»åŠ ä½“ç§¯çƒŸé›¾ï¼Œåœ¨å†…éƒ¨å‘ç”Ÿæ•£å°„

## Motion Blur
### è€ƒè™‘æ—¶é—´çš„å…‰çº¿è¿½è¸ª Introduction of SpaceTime Ray Tracing
ç”¨è›®åŠ›(Brute-Force)å°±å¯ä»¥å®ç°åŠ¨æ€æ¨¡ç³Šï¼šæ¨¡æ‹Ÿå¿«é—¨æ—¶é—´ï¼Œæ¯ä¸ªåƒç´ çœ‹åˆ°çš„é¢œè‰²æ˜¯ä¸€æ®µæ—¶é—´çš„å¹³å‡ï¼›ç›¸æœºå’Œç‰©ä½“éƒ½å¯ä»¥éšæ—¶é—´ç§»åŠ¨

### æ›´æ–°ç›¸æœºç±»æ¥æ¨¡æ‹ŸåŠ¨æ€æ¨¡ç³Š Updating the Camera to Simulate Motion Blur
ä¿®æ”¹`get_ray`å‡½æ•°ï¼Œåœ¨ç›¸æœºå¿«é—¨æ—¶é—´èŒƒå›´å†…éšæœºä¸€ä¸ªæ—¶é—´ç‚¹ï¼Œå‡è®¾å…‰çº¿åœ¨é‚£ä¸ªæ—¶é—´å‡ºç°

### å®ç°ç§»åŠ¨çš„çƒä½“
çƒå¿ƒåœ¨ä¸¤ä¸ªæ—¶é—´ç‚¹ä»ä¸€å¤„å˜åˆ°å¦ä¸€å¤„ï¼Œä¾æ­¤å†™å‡ºçƒå¿ƒ`center`å…³äºæ—¶é—´çš„å‡½æ•°

ä»¥æ™®é€šçƒä½“ä¸ºåŸºç¡€å†™å‡º`hit`ã€‚å…‰çº¿ä¸çƒä½“ç›¸äº¤æ—¶åªè€ƒè™‘å…‰çº¿å‡ºç°æ—¶é—´å¯¹åº”çš„çƒå¿ƒä½ç½®ï¼Œç›¸å½“äºåªæ˜¯ç”¨ä¸¤ç‚¹ç¡®å®šçƒçš„ç›´çº¿è·¯å¾„ï¼Œè€Œéåªåœ¨è¯¥æ—¶é—´èŒƒå›´å†…å­˜åœ¨

![](products\the_next_week\moving_shpere.png)

## BVH(Bounding Volume Hierarchies) å±‚æ¬¡åŒ…å›´ç›’
>[å±‚æ¬¡åŒ…å›´ç›’- Raytracing The Next Week](https://zhuanlan.zhihu.com/p/77261149) 

è®¡ç®—å…‰çº¿ä¸ç‰©ä½“ç›¸äº¤è¿™ä¸ªè¿‡ç¨‹æ˜¯å…‰çº¿è¿½è¸ªçš„ä¸»è¦æ—¶é—´æ€§èƒ½ç“¶é¢ˆã€‚æ¯æ¬¡å‘å°„å…‰çº¿åï¼Œè¿ç®—æ—¶é—´ä¸ç‰©ä½“æ•°ç›®çº¿æ€§æ­£ç›¸å…³ã€‚ç”¨å±‚æ¬¡åŒ…å›´ç›’å®ç°ç±»ä¼¼äºŒåˆ†æŸ¥æ‰¾æ•ˆæœã€‚

(ä»Šå¤©è¿˜çœ‹äº†`SIMD`ç›¸å…³èµ„æ–™ï¼Œä¹‹å‰è¿˜å­¦ä¹ äº†å……åˆ†åˆ©ç”¨äº†å¹¶è¡Œå’Œ`SIMD`çš„`ndarray`åº“ï¼Œä»¥åå¯ä»¥ç”¨å®ƒæ›¿ä»£è‡ªå·±çš„`Vec3`ã€‚å½“ç„¶ç°åœ¨æ²¡å¿…è¦è¿‡æ—©ä¼˜åŒ–)

### æ€è·¯
äºŒåˆ†åœ°åˆ’åˆ†ç©ºé—´æœ‰å¤šç§æ–¹å¼ï¼Œè¿™é‡Œé€‰æ‹©`AABB`(åæ ‡è½´è½´å¯¹é½çš„åŒ…å›´ç›’)ï¼Œå¹¶éšæœºé€‰æ‹©ä¸€ä¸ªåæ ‡è½´è¿›è¡Œæ’åºåäºŒåˆ†ã€‚å®é™…ä¸Šä¹Ÿå¯ä»¥æŒ‰ç…§æœ€é•¿çš„è½´(å·¦å³å·®è·æœ€å¤§)è¿›è¡ŒäºŒåˆ†ã€‚

#### æ‰€éœ€è¿‡ç¨‹
1. æ„å»ºåæ ‡è½´å¯¹é½çš„åŒ…å›´ç›’ç±»(`AABB`)
   1. ä¸º`Hittable Trait`å®ç°`bounding_box`æ–¹æ³•ï¼Œè·å–å…¶åŒ…å›´ç›’
   2. ç¡®å®šæ¯ç§ç‰©ä½“(`Hittable`)çš„åŒ…å›´ç›’(`AABB`)ã€‚å®ƒè¦åŒ…è£¹åŸç‰©ä½“ï¼ŒåŒæ—¶è¶Šå°è¶Šå¥½
2. å®ç°åˆå¹¶ä¸¤ä¸ªç‰©ä½“åŒ…å›´ç›’çš„æ–¹æ³•(`surrounding_box`)
3. æ„å»ºå±‚æ¬¡åŒ…å›´ç›’(BVH)æ ‘èŠ‚ç‚¹ç±»(`BvhNode`)ï¼Œæ¯ä¸ªèŠ‚ç‚¹æ‹¥æœ‰è‡ªå·±çš„åŒ…å›´ç›’(`AABB`)ï¼Œä»¥åŠä¸¤ä¸ªå„¿å­ã€‚
   1. å®ç°å»ºæ ‘ç®—æ³•ï¼Œèƒ½å¤Ÿå°†å¤šä¸ªç‰©ä½“(`HittableList`/`[Arc<dyn Hittable>]`)é€å±‚è¿›è¡Œåˆ’åˆ†ï¼Œæœ€ç»ˆå°†å•ä¸ªç‰©ä½“å­˜å…¥åŒ…å›´ç›’çš„å¶èŠ‚ç‚¹ä¸­ï¼ŒåŒ…å›´ç›’é€å±‚ç¼©å°ã€‚
   2. ä¸ºå…¶å®ç°`Hittable Trait`

#### å®ç°&ä¿®bug
* å› ä¸º`BVH`æ ‘å½¢ç»“æ„çš„æ‰€æœ‰æƒé—®é¢˜è¾ƒä¸ºå¤æ‚ï¼Œéš¾ä»¥å†ä½¿ç”¨`Box`æˆ–è€…æ™®é€šå¼•ç”¨ã€‚äºæ˜¯å…¨éƒ¨é‡æ„æˆäº†ä½¿ç”¨å¼•ç”¨è®¡æ•°æ™ºèƒ½æŒ‡é’ˆï¼ˆç†è®ºä¸Šè¿˜æ˜¯å¯ä»¥ä½¿ç”¨Boxçš„ï¼Œåªæ˜¯å¯è¯»æ€§ä¼šå·®ä¸€ä¸‹ï¼‰ã€‚åˆå› ä¸ºè¦å¹¶è¡Œå¤„ç†ï¼Œäºæ˜¯é‡‡ç”¨`Arc`ã€‚å¹¶æŠŠå‰é¢`HittableList`ä¸­çš„`Box`ä¹Ÿæ”¹æˆäº†`Arc`
  * æ„å¤–å‘ç°Boxç‰ˆæœ¬å’ŒArcç‰ˆæœ¬çš„æ€§èƒ½å¹¶æ²¡æœ‰ç›¸å·®å¾ˆå¤šã€‚æ‰€ä»¥è¿˜æ˜¯**ä¸è¦è¿‡æ—©ä¼˜åŒ–å‘€**
* æ”¹è¿›äº†æµ‹è¯•æµç¨‹ï¼Œå°†æµ‹è¯•è£…å…¥`tests`æµ‹è¯•æ¨¡å—è€Œä¸æ˜¯åœ¨`main`é‡ŒæŠ˜è…¾
  * åªæ˜¯åœ¨æµ‹è¯•ä¸­è¾“å‡ºé”™è¯¯ä¿¡æ¯éœ€è¦å†™`$env:RUST_TEST_NOCAPTURE=1`
* æµ®ç‚¹æ•°`sort`éœ€è¦`sort_by`ä¼ å…¥è°ƒç”¨`partial_cmp`çš„é—­åŒ…(å¹¶åœ¨é‡Œé¢å¤„ç†é”™è¯¯)ï¼Œè€Œä¸èƒ½ç›´æ¥æ’åº
* é¢å¯¹æˆå¨çš„`Option`ï¼Œå–„ç”¨`if let`å¯ä»¥è®©ä»£ç ä¸é‚£ä¹ˆå•°å—¦
* bug fix: åŒºé—´åˆ’åˆ†å¿˜è®°äº†æ˜¯å‰é—­åå¼€ï¼Œä¸å°å¿ƒå†™æˆäº†`[..mid]`å’Œ`[mid+1..]`

### æˆæœ
![](imgs/2023-03-07-20-42-28.png) 
-> 
![](imgs/2023-03-08-17-20-20.png)

å‡å°‘äº†ä¸€åŠç”¨æ—¶ï¼Œä¸”ç‰©ä½“è¶Šå¤šä¼˜åŒ–æ•ˆæœä¼šè¶Šæ˜æ˜¾

### å°ç»“
è¿™æ˜¯åˆ°ç›®å‰ä¸ºæ­¢æœ€å¤§çš„ä¸€ä¸ªæŒ‘æˆ˜ï¼Œä¹‹å‰æ²¡æœ‰ç”¨`Rust`å®ç°è¿‡æ ‘å½¢ç»“æ„ï¼Œç°åœ¨é€šè¿‡å®ç°`BVH`è¿™ä¸ªåªè¯»çš„æ ‘å½¢ç»“æ„ï¼ŒåŠ æ·±äº†å¯¹`Rust`æ™ºèƒ½æŒ‡é’ˆçš„ç†è§£

## Solid Textures å›ºä½“æè´¨
å°†æè´¨è´´å›¾/é¢œè‰²ä¿¡æ¯æ˜ å°„åˆ°å½¢çŠ¶ä¸Š

### æŠ½è±¡æè´¨ï¼šTexture Trait
éœ€è¦å®ç°é€šè¿‡ä¸€ä¸ªuvåæ ‡ç¡®å®šä¸€ä¸ªé¢œè‰²(`Color3`)

### å®ç°ç¬¬ä¸€ä¸ªæè´¨ï¼šçº¯è‰²æè´¨ Constant Texture

### çƒä½“çš„uvåæ ‡
é€šè¿‡æåæ ‡ç³»(åªæœ‰ä¸€ä¸ªé¢ï¼Œæ‰€ä»¥åªéœ€è¦ä»°è§’å’Œæ–¹ä½è§’ä¸¤ä¸ªåæ ‡ï¼Œè€Œä¸éœ€è¦ä½¿ç”¨çƒæåæ ‡ç³»)å°†çƒä¸Šä¸€ä¸ªç‚¹ä¸è´´å›¾å¹³é¢ä¸Šçš„ä¸€ä¸ªç‚¹ä¸€ä¸€å¯¹åº”ï¼š
* è®¡ç®— $(\theta, \phi)$ , å…¶ä¸­ $\theta$ æ˜¯ä»å—æç‚¹å¾€ä¸Šçš„ä»°è§’ï¼ŒèŒƒå›´ $[0,\pi]$ ;  $\phi$  æ˜¯ç»•Yè½´çš„æ–¹ä½è§’ï¼ŒèŒƒå›´ $[0, 2\pi]$  (from -X to +Z to +X to -Z back to -X)
* å°† $\theta$ ä¸ $\phi$ æ˜ å°„åˆ°å¹³é¢åæ ‡ç³»ä¸Š: 

$$u=\frac \phi {2\pi},\qquad v= \frac \theta \pi, u,v \in [0,1]$$

* ä¸ºäº†è®¡ç®—ä»¥åŸç‚¹ä¸ºçƒå¿ƒçš„å•ä½çƒä½“çš„ $\theta$ å’Œ $\phi$ ï¼Œæˆ‘ä»¬éœ€è¦ä»ä¸‰ç»´ç¬›å¡å°”åæ ‡ç³»ä¸Šä¸€ç‚¹å¼€å§‹è®¡ç®—ï¼š

$$y=âˆ’\cos(\theta) \\
x=âˆ’\cos(\phi)\sin(\theta) \\
z=\sin(\phi)\sin(\theta)$$

### Checker Texture
æ£‹ç›˜ä¸€æ ·çš„åŒçº¯è‰²æè´¨ï¼Œæ ¹æ® 

$$\sin(10\cdot p.x()) \times \sin(10\cdot p.y())\times \sin(10\cdot p.z())$$ 

çš„æ­£è´Ÿæ€§æ¥åœ¨3Dé¢ä¸Šç”ŸæˆCheckeræè´¨

### å®ç°ç»†èŠ‚
* è¿›ä¸€æ­¥æ”¹è¿›äº†æµ‹è¯•æµç¨‹ï¼Œå…·ä½“å¦‚ä¸‹
  * ä¹‹å‰ä¸å°å¿ƒä½¿ç”¨äº†é›†æˆæµ‹è¯•ï¼Œæ”¾åœ¨é¡¹ç›®ç›®å½•`/tests`ä¸‹ï¼Œæœ¬è´¨ä¸Šæ˜¯åœ¨`crate`çš„å¤–éƒ¨å¯¹æ•´ä¸ª`crate`è¿›è¡Œæµ‹è¯•ï¼Œå¹¶å¤ªé€‚åˆæˆ‘å®é™…ä¸Šçš„æµ‹è¯•å†…å®¹ã€‚
  * äºæ˜¯æ”¹æˆäº†å•å…ƒæµ‹è¯•ï¼Œæ”¾åœ¨`/src/test`æ¨¡å—ä¸­ï¼Œæµ‹è¯•ä»£ç å¹¶ä¼šä¸å¯¹å¤–å…¬å¼€(æš´éœ²)ã€‚
  * æµ‹è¯•å›¾ç‰‡ç»Ÿä¸€æ”¾è‡³`/imgs/test`ï¼Œå¹¶ä»¥æµ‹è¯•å‡½æ•°åæ¥å‘½å(`Rust`æ²¡æœ‰åå°„ï¼Œæš‚æ—¶ä¹Ÿæ²¡æœ‰åƒ`C/C++`ä¸€æ ·çš„`__func__`å®˜æ–¹å®æ¥è¾“å‡ºå½“å‰å‡½æ•°åï¼Œæ‰€ä»¥åªèƒ½åˆ©ç”¨ç¬¬ä¸‰æ–¹åº“`function_name`æ¥è·å–å½“å‰å‡½æ•°å)
  * ç¼©å°äº†æµ‹è¯•å›¾ç‰‡çš„è¾“å‡ºåˆ†è¾¨ç‡ï¼Œå‡å°‘å‡ºå°„é€’å½’å±‚æ•°ï¼Œæé«˜æµ‹è¯•æ•ˆç‡
* è¿˜æ”¹è¿›äº†é¡¹ç›®ç»“æ„ï¼Œå¢åŠ äº†ä¸€äº›æ¨¡å—å±‚æ¬¡(`hittable`,`material`,`textures`,`test`)è®©é¡¹ç›®ä»£ç æ›´æ¸…æ™°(`use`æš‚æ—¶æ¯”è¾ƒæ‚ä¹±ï¼Œä»¥ åå†æ•´ç†)

### æˆæœ
![](imgs\test\render_scene_with_checker.png)

## Perlin Noise æŸæ—å™ªéŸ³
[ä»éšæœºæ•°åˆ°è‡ªç„¶ç•Œä¸­çš„å™ªå£°ä¹‹ä¸€Value Noise](https://zhuanlan.zhihu.com/p/77596796)
[ä»éšæœºæ•°åˆ°è‡ªç„¶ç•Œä¸­çš„å™ªå£°ä¹‹äºŒ-Perlin Noise](https://zhuanlan.zhihu.com/p/77628759)
>[æŸæ—å™ªå£° (å¤šå›¾)](https://blog.csdn.net/u010669231/article/details/97051705)
### æ¦‚è¿°
è‡ªç„¶ç•Œçš„å™ªå£°ï¼šå±€éƒ¨å˜åŒ–å°ï¼›å…¨å±€å˜åŒ–å¤§

ä¼ªéšæœºç”Ÿæˆçš„ç™½å™ªéŸ³ï¼šå±€éƒ¨å˜åŒ–å¤§ï¼›å…¨å±€å®Œå…¨æ— è§„å¾‹å¯è¨€

### æŸæ—å™ªéŸ³ä¼˜åŠ¿
* è·å¾—æ¯”ç™½å™ªéŸ³(çº¯ç²¹éšæœº)æ›´è‡ªç„¶çš„éšæœºçº¹ç†
* æœ‰å¯å†ç°çš„ç‰¹æ€§(åŒæ ·çš„ç‚¹è¿”å›åŒæ ·çš„éšæœºä¿¡æ¯)
* åœ¨ä¸€ç‚¹çš„å‘¨å›´é¢œè‰²è¾ƒä¸ºå‡åŒ€
* è€Œä¸”è®¡ç®—å¿«é€Ÿ

![](imgs/2023-03-16-20-42-29.png)

### ç”¨éšæœºæ•°ç”Ÿæˆçº¹ç†
ç”¨ä¸€ä¸ªéšæœºæ•°åˆ—ç”Ÿæˆçº¹ç†ï¼Œå°†ä¸€ä¸ªå•ä½(å¦‚ä¸€ä¸ª1è¾¹é•¿ç«‹æ–¹ä½“)å½“ä½œä¸€å—ï¼Œæ˜ å°„åˆ°ä¸€ä¸ªé¢œè‰²ã€‚çº¹ç†æ˜æ˜¾ä¼šé‡å¤ä¸”æ— åº

### å°†åæ ‡è¿›è¡Œå“ˆå¸Œ
çº¹ç†ä¸å†é‚£ä¹ˆé‡å¤ï¼Œä½†è¿˜æ˜¯å®Œå…¨æ— åºï¼Œä¸å¥½çœ‹

### å¹³æ»‘åŒ–
ç”¨`ä¸‰çº¿æ€§æ’å€¼`å¯¹çº¹ç†è¿›è¡Œå¹³æ»‘åŒ–ï¼Œç»“æœå˜æ¨¡ç³Šäº†

ä½†è¿˜æ˜¯ä¸å¤Ÿå¹³æ»‘ï¼Œå› ä¸ºåœ¨ç«‹æ–¹ä½“æ ¼ç‚¹ä¸­å¿ƒè¿˜æ˜¯å®Œå…¨éšæœºè¿›è¡Œçªå˜çš„(æœ€å€¼æ€»æ˜¯ç²¾ç¡®è½åœ¨æ•´æ•°x/y/zä¸Š)ï¼Œç»“æœæœ‰æ˜æ˜¾çš„ç½‘æ ¼ç‰¹å¾

### Hermitianå¹³æ»‘åŒ–
ä¸ç”¨çº¿æ€§æ’å€¼ï¼Œè€Œæ”¹ç”¨`Hermitian`å¹³æ»‘åŒ–æ’å€¼

å¹³æ»‘äº†å¾ˆå¤šä½†æ•ˆæœè¿˜æ˜¯ä¸è‡ªç„¶

### æ”¯æŒæ”¹å˜é¢‘ç‡
å¢åŠ ç¼©æ”¾å› å­å°†çº¹ç†è¿›è¡Œç¼©æ”¾

### çœŸæ­£çš„æŸæ—å™ªå£°
åœ¨æ ¼ç‚¹ä¸Šå­˜å‚¨`xyz`ä¸‰ä¸ªæ–¹å‘éšæœºå‘é‡ï¼Œè€Œéç²—æš´åœ°å­˜å‚¨ä¸€ä¸ªå€¼ä½œä¸ºé¢œè‰²ç°åº¦ï¼Œå››ä¸ªæ ¼ç‚¹ç»„æˆæ­£æ–¹å½¢å½¢æˆä¸€ä¸ªæ™¶æ ¼

è®¡ç®—ä¸€ç‚¹é¢œè‰²æ—¶å“ˆå¸Œåˆ°æŸä¸€ä¸ªæ™¶æ ¼ï¼Œå¹¶è·å–ç›¸å¯¹æ™¶æ ¼å·¦ä¸‹è§’æ ¼ç‚¹çš„ä½ç½®å‘é‡ï¼Œå°†å…¶ä½œä¸ºæ¢¯åº¦ï¼ŒæŒ‰ä¸€å®šçš„åŠ æƒè®¡ç®—å‡ºåƒç´ ç°åº¦ï¼Œè¿™æ ·å°±ç”Ÿæˆå‡ºäº†è¾ƒä¸ºæ ‡å‡†çš„`Perlin`å™ªå£°çº¹ç†ã€‚

(æ²¡æœ‰å®Œå…¨ææ‡‚ï¼Œè¿™é‡Œå¯èƒ½æœ‰é”™è¯¯ï¼Œå‚è€ƒ[https://www.cnblogs.com/leoin2012/p/7218033.html](https://www.cnblogs.com/leoin2012/p/7218033.html))

è¿˜èƒ½è¿›è¡Œä¸€äº›å åŠ æˆ–å˜åŒ–(å–ç»å¯¹å€¼ï¼ŒåŠ æ—‹åº¦Â·Â·Â·)å½¢æˆæ›´å¥‡ç‰¹çš„å™ªå£°çº¹ç†

## Image Texture Mapping å›¾åƒæè´¨æ˜ å°„
å’Œå™ªå£°çº¹ç†ç›¸æ¯”ï¼Œæ˜¾ç„¶èƒ½æ˜¾ç¤ºä¸€ä¸ªåœ°çƒä»ªæ›´åŠ æœ‰è¶£ï¼Œæ‰€ä»¥å…ˆçœ‹è¿™ç« å§ã€‚

ä¸ºäº†å®ç°ä¸ä¸åŒå›¾åƒåˆ†è¾¨ç‡çš„å…¼å®¹æ€§ï¼Œé€šå¸¸æŠŠuvåæ ‡å…ˆæ˜ å°„åˆ°ä¸€ä¸ªå›¾åƒä½ç½®çš„æ¯”å€¼è€Œéå…·ä½“çš„ä¸€ä¸ªåƒç´ ç‚¹ã€‚å¯¹äº $N_x \times N_y$ å›¾åƒåƒç´ ç‚¹`(i,j)`:
$$u = \frac i {N_x-1}, v = \frac j {N_y-1}$$

### å­˜å‚¨æè´¨å›¾åƒæ•°æ®
å›¾åƒè§£æé‡‡ç”¨`image crate`ï¼Œå­˜å‚¨ä½¿ç”¨å…¶ä¸­çš„`DynamicImage`ï¼Œå®ƒé‡‡ç”¨çš„æ˜¯`RGBA`å››ç»´åº¦å­˜å‚¨ï¼Œä½†ä¹Ÿèƒ½å…¼å®¹`JPG`

## é•¿æ–¹å½¢å’Œå…‰
æ—©æœŸå…‰è¿½æ¸²æŸ“å™¨ç”¨æŠ½è±¡å…‰æº(ç‚¹å…‰æº/çº¿å…‰æº)ï¼›è€Œç°ä»£æ¸²æŸ“å™¨æœ‰äº†æ›´ç‰©ç†çš„å…‰æºï¼Œæ‹¥æœ‰ä½ç½®å’Œå¤§å°ã€‚æˆ‘ä»¬å¯ä»¥è®©ä»»ä½•ç‰©ä½“å‘å…‰

### å‘å…‰ææ–™
`Material`æ–°å¢`emitted`æ–¹æ³•ï¼Œè¡¨ç¤ºå‘å…‰å±æ€§ï¼Œ`ray_color`ç”Ÿæˆé¢œè‰²æ—¶ä¸`scatter`ç»“æœç›¸åŠ ï¼Œé»˜è®¤å®ç°ç›´æ¥è¿”å›`Color::black()`ä»£è¡¨ä¸å‘å…‰

### èƒŒæ™¯é¢œè‰²
ä¸å†æ’å€¼è®¡ç®—èƒŒæ™¯é¢œè‰²ï¼Œè€Œæ˜¯ç”¨çº¯è‰²æ¥ä½œä¸ºèƒŒæ™¯ï¼Œé»˜è®¤ä¸ºé»‘è‰²

### é•¿æ–¹å½¢
å°±æ˜¯æŸä¸€ç»´æå°çš„é•¿æ–¹ä½“ï¼Œç»™å‡ºä¸¤ä¸ªç»´åº¦çš„èŒƒå›´å’Œä¸€ä¸ªç»´åº¦çš„å€¼å°±å¯ä»¥è·å¾—ä¸æŸä¸¤åæ ‡è½´å¹³è¡Œçš„é•¿æ–¹å½¢

### å®ç°å‘å…‰ç‰©ä½“
å®ç°`DiffuseLight`ï¼Œä½œä¸ºæ²¡æœ‰çº¹ç†åªæ˜¯å‘å…‰çš„ç®€å•å‘å…‰ææ–™

### Cornell box
ç»å…¸çš„äº”é¢å¢™å’Œä¸€ç›ç¯

### Instances
`CornellBox`é‡ŒåŠ ä¸¤ä¸ªç»å…¸ç«‹æ–¹ä½“

### æ€§èƒ½åˆ†æåŠä¼˜åŒ–
è£…äº†`Win11`å°±å¿ä¸ä½æ‘†å¼„`WSL2`ï¼Œäºæ˜¯æƒ³è¯•è¯•ç”¨`perf`ä¹‹ç±»çš„æ¥åˆ†ææ€§èƒ½ã€‚æ‰¾åˆ°äº†ä¸é”™çš„ä¸œè¥¿ï¼š
* crates:`Criterion`ã€`Flamegraph`
* Hotspot(Qtå†™çš„ç«ç„°å›¾ç”Ÿæˆ)
ä¹Ÿè¸©äº†äº¿äº›å‘ï¼Œä¸»è¦æ˜¯åœ¨è‡ªå·±ç¼–è¯‘`perf`è¿‡ç¨‹ä¸­

>[Rustæ€§èƒ½è¯„ä¼°ä¸è°ƒä¼˜å®è·µ - Rustç²¾é€‰ (rustmagazine.github.io)](https://rustmagazine.github.io/rust_magazine_2021/chapter_12/rust-perf.html)
>
>[with the linux perf tool - Rust Compiler Development Guide (rust-lang.org)](https://rustc-dev-guide.rust-lang.org/profiling/with_perf.html)

#### å­¦ä¹ ä½¿ç”¨Criterionè¿›è¡Œbenchmark

#### å­¦ä¹ ä½¿ç”¨FlameGraphç”Ÿæˆç«ç„°å›¾ï¼ˆstuckï¼‰

#### perf WSL2 è¸©å‘è®°
##### ç¼–è¯‘perf
```bash
Warning: Kernel ABI header at 'tools/arch/x86/include/asm/cpufeatures.h' differs from latest version at 'arch/x86/include/asm/cpufeatures.h'
diff -u tools/arch/x86/include/asm/cpufeatures.h arch/x86/include/asm/cpufeatures.h
Warning: Kernel ABI header at 'tools/arch/x86/include/asm/msr-index.h' differs from latest version at 'arch/x86/include/asm/msr-index.h'
diff -u tools/arch/x86/include/asm/msr-index.h arch/x86/include/asm/msr-index.h
Warning: Kernel ABI header at 'tools/arch/arm64/include/uapi/asm/kvm.h' differs from latest version at 'arch/arm64/include/uapi/asm/kvm.h'
diff -u tools/arch/arm64/include/uapi/asm/kvm.h arch/arm64/include/uapi/asm/kvm.h
Makefile.config:454: No libdw DWARF unwind found, Please install elfutils-devel/libdw-dev >= 0.158 and/or set LIBDW_DIR
Makefile.config:459: No libdw.h found or old libdw.h found or elfutils is older than 0.138, disables dwarf support. Please install new elfutils-devel/libdw-dev
Makefile.config:587: DWARF support is off, BPF prologue is disabled
Makefile.config:595: No sys/sdt.h found, no SDT events are defined, please install systemtap-sdt-devel or systemtap-sdt-dev
Makefile.config:761: slang not found, disables TUI support. Please install slang-devel, libslang-dev or libslang2-dev
Makefile.config:887: Old version of libbfd/binutils things like PE executable profiling will not be available
Makefile.config:905: No bfd.h/libbfd found, please install binutils-dev[el]/zlib-static/libiberty-dev to gain symbol demangling
Makefile.config:949: No libzstd found, disables trace compression, please install libzstd-dev[el] and/or set LIBZSTD_DIR
Makefile.config:960: No libcap found, disables capability support, please install libcap-devel/libcap-dev
Makefile.config:973: No numa.h found, disables 'perf bench numa mem' benchmark, please install numactl-devel/libnuma-devel/libnuma-dev
Makefile.config:1028: No libbabeltrace found, disables 'perf data' CTF format support, please install libbabeltrace-dev[el]/libbabeltrace-ctf-dev
Makefile.config:1054: No alternatives command found, you need to set JDIR= to point to the root of your Java directory

Auto-detecting system features:
...                         dwarf: [ OFF ]
...            dwarf_getlocations: [ OFF ]
...                         glibc: [ on  ]
...                        libbfd: [ OFF ]
...                libbfd-buildid: [ OFF ]
...                        libcap: [ OFF ]
...                        libelf: [ on  ]
...                       libnuma: [ OFF ]
...        numa_num_possible_cpus: [ OFF ]
...                       libperl: [ on  ]
...                     libpython: [ on  ]
...                     libcrypto: [ on  ]
...                     libunwind: [ on  ]
...            libdw-dwarf-unwind: [ OFF ]
...                          zlib: [ on  ]
...                          lzma: [ on  ]
...                     get_cpuid: [ on  ]
...                           bpf: [ on  ]
...                        libaio: [ on  ]
...                       libzstd: [ OFF ]
...        disassembler-four-args: [ OFF ]
```
ç›´æ¥ä½¿ç”¨çš„è¯`C++`å’Œ`Rust`éƒ½æ²¡æœ‰`demangle`ï¼Œä¸”`Rust`æ•°æ®`flamegraph`crateå®Œå…¨åˆ†æä¸å‡ºæ¥ï¼Œåªæœ‰ä¸ª`unknown`ã€‚

æ‰¾åˆ°è¿™äº›åº“ï¼Œè£…å®Œä»¥åå†ç¼–è¯‘æ‰è¡Œã€‚
å¼„äº†å¥½ä¹…å‘ç°æ²¡æœ‰æ•ˆæœï¼Œæœ€åå‘ç°æŠŠå¯æ‰§è¡Œæ–‡ä»¶æ”¾é”™äº†ä½ç½®ï¼Œ`PATH`é‡Œæœ‰`/usr/bin`å’Œ`/usr/local/bin`ç­‰å¤šå¤„ï¼Œè€Œä¼˜å…ˆè°ƒç”¨çš„æ˜¯`/usr/local/bin`ä¸­çš„ï¼Œæˆ‘æ”¾é”™äº†æ‰€ä»¥ä¸€ç›´éƒ½æ²¡ç”¨æˆæœ€æ–°ç¼–è¯‘çš„è¿™ä¸ªã€‚ã€‚ã€‚
##### ä½¿ç”¨perfç›‘æµ‹æ€§èƒ½
* `perf record --call-graph dwarf -g +ç¨‹åºå`ï¼šé€‚é…Rustçš„è°ƒè¯•ä¿¡æ¯ï¼Œç”Ÿæˆæˆå¨çš„data
* `perf report -demangle`ï¼šå¯ä»¥è§£C++/Rustç­‰çš„ç¬¦å·ï¼Œå¦åˆ™å‡½æ•°åä¸å¯è¯»
##### FlameGraph.pl
`Perl`å†™çš„ç”¨`perf`æ•°æ®ç”Ÿæˆç«ç„°å›¾

##### FlameGraph.rs
æ¯”`perl`çš„æ›´å¿«ï¼Œ`cargo flamegraph`ä¸€é”®è°ƒç”¨

##### Hotspot
åˆ†æ`C/Qt/C++`ç›¸å½“å¥½ç”¨

### æ—‹è½¬
ç›¸æ¯”æ—‹è½¬å’Œç§»åŠ¨ç‰©ä½“ï¼Œæˆ‘ä»¬é€‰æ‹©ç”¨ç›¸åçš„è§’åº¦æ—‹è½¬å…‰çº¿æˆ–è€…ç»™å…‰çº¿ç›¸åçš„ä½ç§»ï¼Œå«åš`Instance Translation`

åˆ†åˆ«å®ç°ä»¥ä¸‰ä¸ªåæ ‡è½´ä¸ºæ—‹è½¬è½´çš„æ—‹è½¬

## ä½“ç§¯é›¾/ä½“æ¸²æŸ“ Volumes
ä½“ç§¯å’Œè¡¨é¢å‡ ä¹æ˜¯å®Œå…¨ä¸åŒçš„ä¸¤æ ·ä¸œè¥¿ï¼Œè¿™å¯èƒ½åŠ å‰§æˆ‘ä»¬è½¯ä»¶æ¸²æŸ“æ¶æ„çš„æ··ä¹±ã€‚è€Œä¸€ä¸ªæœ‰æ„æ€çš„æŠ€æœ¯æ˜¯æŠŠä½“ç§¯å½“æˆéšæœºå­˜åœ¨çš„è¡¨é¢

### å¯†åº¦ä¸€å®šçš„ä»‹è´¨ Constant Density Mediums
è¿›å…¥ä»‹è´¨çš„å…‰å¯èƒ½ä»å†…éƒ¨æŸç‚¹æ•£å°„ï¼Œä¹Ÿå¯èƒ½å¾„ç›´ç©¿è¿‡ä»‹è´¨ã€‚æ ¹æ®å¯†åº¦ä¸åŒè¿™ä¸¤è€…çš„åˆ†é…æƒ…å†µä¸åŒ